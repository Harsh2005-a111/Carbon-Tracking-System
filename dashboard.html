<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | CarbonTrack</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <h2>CarbonTrack</h2>
            <div style="margin-top:20px;">
                <a href="dashboard.html" class="nav-link active">üìä Dashboard</a>
                <a href="emissions.html" class="nav-link">üìù Emissions</a>
                <a href="analytics.html" class="nav-link">üìà Analytics & AQI</a>
            </div>
            <button class="logout" onclick="sessionStorage.clear(); window.location.href='index.html'">Logout</button>
        </aside>

        <main class="main">
            <h1 id="welcomeMsg">Dashboard</h1>

            <div class="grid grid-3" style="margin-top:20px;">
                <div class="card">
                    <div class="stat-lbl">Total Emissions</div>
                    <div class="stat-val" id="totalStat">...</div>
                    <small>kg CO2e</small>
                </div>
                <div class="card">
                    <div class="stat-lbl">Total Offsets</div>
                    <div class="stat-val" id="offsetStat" style="color:#38A169">...</div>
                    <small>kg CO2e</small>
                </div>
                <div class="card">
                    <div class="stat-lbl">Net Emissions</div>
                    <div class="stat-val" id="netStat">...</div>
                    <small>kg CO2e</small>
                </div>
            </div>

            <div class="grid grid-2" style="margin-top:20px;">
                <div class="card">
                    <h3>Emission Trend</h3>
                    <canvas id="trendChart"></canvas>
                </div>
                <div class="card">
                    <h3>Gas Breakdown</h3>
                    <canvas id="gasChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="js/supabaseClient.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script>
    <script>
        const user = requireAuth();
        document.getElementById('welcomeMsg').innerText = `Overview: ${user.org_name}`;

        async function loadDash() {
            const stats = await getDashboardStats(user.org_id);
            document.getElementById('totalStat').innerText = formatNum(stats.total_co2e_kg);
            document.getElementById('offsetStat').innerText = formatNum(stats.total_offset_kg);
            document.getElementById('netStat').innerText = formatNum(stats.net_co2e_kg);

            const records = await getEmissionRecords(user.org_id);
            renderTrendChart('trendChart', records);
            renderGasBreakdown('gasChart', records);
        }

        loadDash();
        subscribeToEmissions(loadDash);
    </script>
</body>
</html>
